# ==== ğŸ´ Donkey Assistant Makefile ====
.PHONY: install format setup run kill flush-redis reset-db migrate prompt dev celery redis-start django bootstrap_memory init-db reset_logs codex codex-dry help seed-all

# ==== ğŸ“¦ Setup & Environment ====
install:
	@echo "ğŸ“¦ Installing from requirements.txt..."
	@source .venv/bin/activate && pip install -r requirements.txt

format:
	@echo "ğŸ§½ Formatting code with black..."
	@black .

setup:
	@echo "ğŸ“‚ Ensuring folders exist..."
	@mkdir -p data context prompts
	@touch data/prompt_logs.db
	@touch context/daily_notes.json

init-db:
	@echo "ğŸ—ƒï¸  Initializing prompt_logs.db..."
	@python scripts/init_db.py

bootstrap_memory:
	@echo "ğŸ§  Bootstrapping assistant memory..."
	@python memory/bootstrap.py

reset_logs:
	@echo "ğŸ§¼ Resetting logs and memory..."
	@rm -f prompt_logs.db
	@make bootstrap_memory

# ==== ğŸ§  Prompt Assistant ====
prompt:
	@echo "ğŸ§  Starting prompt menu interface..."
	@source .venv/bin/activate && python command_menu.py

donkey_dev:
	@echo "ğŸ´ Booting up Donkey Dev Assistant..."
	@source .venv/bin/activate && python command_menu.py

donkey_nolog:
	@echo "ğŸš« Running Assistant (no logs)..."
	@USE_LOGGING=False source .venv/bin/activate && python ollama_dev_assistant.py

ingest:
	@echo "ğŸ“¥ Ingesting prompt_sets/..."
	@python manage.py ingest_prompts

# ==== ğŸš€ Django + Redis + Celery ====
run:
	@make redis-start
	@sleep 1
	@make django &
	@sleep 2
	@make celery &
	@echo "â³ Waiting for Django to start..."

redis-start:
	@echo "ğŸŸ¥ Starting Redis..."
	@pgrep redis-server || redis-server

flush-redis:
	@echo "ğŸ’£ Flushing Redis..."
	@redis-cli FLUSHALL

kill:
	@echo "ğŸ’€ Killing dev processes..."
	-@pkill -f 'manage.py runserver' || true
	-@pkill -f 'celery' || true
	-@pkill -f 'redis-server' || true
	-@pkill -f 'vite' || true
	-@pkill -f 'flutter' || true

restart:
	@make kill
	@sleep 1
	@make run

django:
	@echo "ğŸŒ„ Running Django..."
	@python manage.py runserver

celery:
	@echo "ğŸŒªï¸ Starting Celery..."
	@celery -A server worker --loglevel=info --pool=solo

# ==== ğŸ§ª Dev Utilities ====
migrate:
	@python manage.py migrate

reset-db:
	@echo "ğŸ’£ Dropping and recreating DB..."
	dropdb donkey_ai_assistant || true
	createdb donkey_ai_assistant
	find . -path "./.venv" -prune -o -path "*/migrations/*.py" -not -name "__init__.py" -delete
	find . -path "./.venv" -prune -o -path "*/migrations/*.pyc" -delete
	python manage.py makemigrations
	python manage.py migrate

# ==== ğŸ¤– Codex ====
codex:
	@echo "âš¡ Running Codex Helpers"
    @PYTHONPATH=$(PWD) python backend/tools/run_codex_tasks.py

codex-dry:
	@echo "ğŸ§ƒ [DRY RUN] Codex Helpers"
    @CODEX_DRY_RUN=1 PYTHONPATH=$(PWD) python backend/tools/run_codex_tasks.py

# ==== ğŸŒ± Seeder Shortcut ====
seed-all:
	@echo "ğŸŒ± Running all seed scripts..."
	@python manage.py ingest_prompts && \
	python manage.py clear_thoughts && \
	python manage.py seed_assistants && \
	python manage.py seed_assistant_projects && \
	python manage.py seed_signals && \
	python manage.py seed_thoughts && \
	python manage.py seed_memory_entries && \
	python manage.py seed_memory_contexts && \
	python manage.py seed_prompt_usage_templates && \
	python manage.py seed_all_prompts && \
	python manage.py seed_prompt_presets && \
	python manage.py seed_prompt_placement && \
	python manage.py seed_default_themes && \
	python manage.py backfill_token_counts && \
	python manage.py reembed_all_prompts && \
	python manage.py reembed_mcp_core && \
	python manage.py seed_embeddings && \
	python manage.py check_embedding_status && \
	python manage.py post_seed_dashboard && \
	echo "ğŸŒ¾ All seeders executed successfully!"

post-seed-dashboard:
	@python manage.py check_post_seed_status

safe-restart:
	@echo "ğŸ§¼ Graceful restart (kill + run + flush)..."
	@echo "ğŸ’€ Killing dev processes..."
	pkill -f runserver || true
	pkill -f celery || true
	pkill -f redis-server || true
	sleep 1
	@make run &
	sleep 5


	
# ==== ğŸ§™ Help ====
help:
	@echo "\nğŸ§™â€â™‚ï¸ Donkey Assistant Commands:"
	@echo "  make install           ğŸ“¦ Install dependencies"
	@echo "  make prompt            ğŸ§  Run prompt menu"
	@echo "  make ingest            ğŸ“¥ Ingest prompt_sets markdown"
	@echo "  make run               ğŸ”„ Start Redis + Django + Celery"
	@echo "  make restart           ğŸ”„ Kill + restart everything"
	@echo "  make format            ğŸ§½ Run black formatter"
	@echo "  make reset-db          ğŸ’£ Drop + re-init DB"
	@echo "  make flush-redis       ğŸ§¨ Clear Redis tasks"
	@echo "  make codex             âš¡ Run Codex script"
	@echo "  make bootstrap_memory  ğŸ§  Load core memory"
	@echo "  make seed-all          ğŸŒ± Run all seeders"
	@echo ""